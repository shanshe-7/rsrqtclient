name: Frontend Deployment
on:
  push:
    branches: [main]
    paths:
      - "**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy Frontend
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          # Set up SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Copy SvelteKit build files
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            -r client/build/* \
            $USERNAME@$HOST:/var/www/sveltekit/
            
          # Copy package files
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            client/build/package.json \
            $USERNAME@$HOST:/var/www/sveltekit/

          # Restart SvelteKit
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $USERNAME@$HOST << 'EOF'
            cd /var/www/sveltekit
            npm install
            pm2 restart sveltekit
          EOF
